<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Optimization Web SDK Dev Development Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      textarea,
      input,
      button {
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          avenir next,
          avenir,
          segoe ui,
          helvetica neue,
          Adwaita Sans,
          Cantarell,
          Ubuntu,
          roboto,
          noto,
          helvetica,
          arial,
          sans-serif;
      }
      h1,
      main {
        max-width: 1040px;
        margin-inline: auto;
      }
      main {
        display: grid;
        grid-gap: 2rem;
        grid-template-rows: auto 1fr;
        grid-template-columns: 1fr auto;
      }
      section:first-of-type {
        grid-column: 1 / span 2;
      }
      ol {
        margin: 0;
      }
      summary {
        cursor: pointer;
      }
      form {
        margin-block: 1rem;
      }
      fieldset {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-gap: 1rem;
      }
      button {
        cursor: pointer;

        &:not([type]) {
          appearance: none;
          background: transparent;
          border: 0;
          padding: 0;
          font-family: inherit;
          font-size: inherit;
          text-decoration: underline;

          &:hover,
          &:active {
            color: blue;
          }
        }
      }
      #event-stream-panel {
        grid-column: 2;
        grid-row: 2 / span 2;

        > div {
          position: sticky;
          top: 0;
          margin-block-start: -1px;
          padding-block-start: 1px;
        }
      }
      #auto-observed,
      #manually-observed {
        display: grid;
        grid-gap: 2rem;
        grid-auto-rows: minmax(75dvh, auto);
        margin-block-end: 2rem;

        > div {
          display: grid;
          grid-gap: inherit;
          grid-auto-rows: inherit;
          width: 100%;
          height: 100%;
          padding: 2rem;
          background: #eee;
          overflow: visible;
        }

        div.nested {
          display: grid;
          grid-gap: inherit;
          grid-auto-rows: inherit;
          padding: 1rem;
          border: 1px solid #ccc;
          overflow: visible;
        }
      }
    </style>
  </head>
  <body>
    <h1>Optimization Web SDK Dev Development Dashboard</h1>

    <main>
      <section>
        <h2>Utilities</h2>

        <span>
          <button id="consent">Accept Consent</button>
          <button id="unconsent">Reject Consent</button>
        </span>
        |
        <span>
          <button id="identify">Identify</button>
          <button id="unidentify">Reset Profile</button>
        </span>
        |
        <button commandfor="profile-dialog" command="show-modal">View Custom Flags</button>
        <dialog id="custom-flags-dialog">
          <pre id="custom-flags"></pre>
          <form method="dialog">
            <button type="submit">Close</button>
          </form>
        </dialog>
        |
        <button commandfor="profile-dialog" command="show-modal">View Profile</button>
        <dialog id="profile-dialog">
          <pre id="profile"></pre>
          <form method="dialog">
            <button type="submit">Close</button>
          </form>
        </dialog>
        |
        <button commandfor="personalizations-dialog" command="show-modal">
          View Personalizations
        </button>
        <dialog id="personalizations-dialog">
          <pre id="personalizations"></pre>
          <form method="dialog">
            <button type="submit">Close</button>
          </form>
        </dialog>
      </section>

      <section>
        <h2>Entry Data</h2>

        <form id="entry-form">
          <fieldset>
            <legend>Resolve Contentful Entry</legend>
            <input type="text" name="entryId" id="entry-id" />
            <button type="submit">Submit</button>
          </fieldset>
        </form>

        <ol id="entries"></ol>
      </section>

      <section id="event-stream-panel">
        <div>
          <h2>Event Stream</h2>

          <ol id="event-stream"></ol>
        </div>
      </section>

      <section>
        <h2>Entries</h2>

        <div id="auto-observed">
          <div data-ctfl-entry-id="1JAU028vQ7v6nB2swl3NBo">
            <!-- Nested Entry -->
          </div>
          <div data-ctfl-entry-id="1MwiFl4z7gkwqGYdvCmr8c">
            <!-- Merge Tag "Rich Text" Entry -->
          </div>
          <div data-ctfl-entry-id="4ib0hsHWoSOnCVdDkizE8d"></div>
          <div data-ctfl-entry-id="xFwgG3oNaOcjzWiGe4vXo"></div>
          <div data-ctfl-entry-id="2Z2WLOx07InSewC3LUB3eX"></div>
        </div>

        <div id="manually-observed">
          <div data-entry-id="5XHssysWUDECHzKLzoIsg1"></div>
          <div data-entry-id="6zqoWXyiSrf0ja7I2WGtYj"></div>
          <div data-entry-id="7pa5bOx8Z9NmNcr7mISvD"></div>
        </div>
      </section>
    </main>

    <template id="event-dialog">
      <li>
        <button></button>
        <dialog>
          <pre></pre>
          <form method="dialog">
            <button type="submit">Close</button>
          </form>
        </dialog>
      </li>
    </template>

    <template id="entry-details-dialog">
      <li>
        <button></button>
        <dialog>
          <div></div>
          <details>
            <summary>JSON</summary>
            <pre></pre>
          </details>
          <form method="dialog">
            <button type="submit">Close</button>
          </form>
        </dialog>
      </li>
    </template>

    <script type="module" src="/src/Optimization.ts"></script>
    <script type="module">
      /* --- Standard Initialization Code --- */

      // Initialize Contentful CDA SDK
      var contentfulClient = contentful.createClient({
        accessToken: '%VITE_CONTENTFUL_TOKEN%',
        environment: '%VITE_CONTENTFUL_ENVIRONMENT%',
        space: '%VITE_CONTENTFUL_SPACE_ID%',
        host: '%VITE_CONTENTFUL_CDA_HOST%',
        basePath: '%VITE_CONTENTFUL_BASE_PATH%',
        insecure: Boolean('%VITE_CONTENTFUL_CDA_HOST%'),
      })

      // Initialize Contentful Optimization Web SDK
      window.optimization = new Optimization({
        clientId: '%VITE_NINETAILED_CLIENT_ID%',
        environment: '%VITE_NINETAILED_ENVIRONMENT%',
        logLevel: 'debug',
        autoTrackEntryViews: true,
        app: {
          name: document.title,
          version: '0.0.0',
        },
        analytics: { baseUrl: '%VITE_INSIGHTS_API_BASE_URL%' },
        personalization: { baseUrl: '%VITE_EXPERIENCE_API_BASE_URL%' },
      })

      // Emit page event
      optimization.personalization.page()

      /* --- Utility Functionality --- */

      const consent = document.getElementById('consent')
      const unconsent = document.getElementById('unconsent')

      function toggleConsent(consented = false) {
        if (consented) {
          consent.setAttribute('style', 'display: none;')
          unconsent.removeAttribute('style')
        } else {
          consent.removeAttribute('style')
          unconsent.setAttribute('style', 'display: none;')
        }
      }

      consent.addEventListener('click', () => optimization.consent(true))
      unconsent.addEventListener('click', () => optimization.consent(false))

      const identify = document.getElementById('identify')
      const unidentify = document.getElementById('unidentify')

      function toggleIdentity(identified = false) {
        if (identified) {
          identify.setAttribute('style', 'display: none;')
          unidentify.removeAttribute('style')
        } else {
          identify.removeAttribute('style')
          unidentify.setAttribute('style', 'display: none;')
        }
      }

      identify.addEventListener('click', () =>
        optimization.personalization.identify({ userId: 'charles', traits: { identified: true } }),
      )
      unidentify.addEventListener('click', () => {
        optimization.reset()
        // Ensure we have a new profile after resetting the old one
        optimization.personalization.page()
      })

      function createEventDialog(title, details) {
        const template = document.querySelector('#event-dialog')
        const clone = template.content.cloneNode(true)
        const dialog = clone.querySelector('dialog')
        const button = clone.querySelector('button')
        const pre = clone.querySelector('pre')

        button.innerText = title
        button.commandForElement = dialog
        button.command = 'show-modal'
        button.dataset.testid = details.componentId ?? details?.properties?.url ?? details.messageId

        pre.innerText = JSON.stringify(details, null, 2)

        return clone
      }

      function createEntryDialog(title, entry, personalization) {
        const template = document.querySelector('#entry-details-dialog')
        const clone = template.content.cloneNode(true)
        const dialog = clone.querySelector('dialog')
        const button = clone.querySelector('button')
        const div = clone.querySelector('div')
        const pre = clone.querySelector('pre')

        button.innerText = title
        button.commandForElement = dialog
        button.command = 'show-modal'

        if (isRichText(entry.fields?.text)) {
          simpleRenderRichText(entry.fields.text, div)
        } else {
          const p = document.createElement('p')
          p.innerText = entry.fields?.text
          div.appendChild(p)
        }

        div.dataset.ctflEntryId = entry.sys?.id

        if (personalization) {
          div.dataset.ctflPersonalizationId = personalization?.experienceId
          div.dataset.ctflSticky = personalization?.sticky
          div.dataset.ctflVariantIndex = personalization?.variantIndex
        }

        pre.innerText = JSON.stringify([entry, personalization], null, 2)

        return clone
      }

      const form = document.querySelector('#entry-form')
      const LAST_ENTRY_ID_KEY = '__ctfl_dev_last_entry_id__'

      form.elements.entryId.value = localStorage.getItem(LAST_ENTRY_ID_KEY)

      form.addEventListener('submit', async (event) => {
        event.preventDefault()

        const data = new FormData(form)
        const entryId = data.get('entryId')

        await addPersonalizedEntry(entryId)

        localStorage.setItem(LAST_ENTRY_ID_KEY, entryId)
      })

      /* --- Standard Rendering Code --- */

      function isRichText(field) {
        return field && typeof field === 'object' && field.content !== undefined
      }

      // Barebones "Rich Text" renderer
      // Full renderer must be customer-supplied, or rendered via ctfl Rich Text libs where possible
      function simpleRenderRichText(field, parent) {
        if (!field || typeof field !== 'object') return
        if (!parent || !(parent instanceof HTMLElement)) return

        if (field.nodeType === 'document') {
          field.content.forEach((content) => simpleRenderRichText(content, parent))
        } else if (field.nodeType === 'paragraph') {
          const p = document.createElement('p')
          field.content.forEach((content) => simpleRenderRichText(content, p))
          parent.appendChild(p)
        } else if (field.nodeType === 'text') {
          const span = document.createElement('span')
          span.innerText = field.value
          parent.appendChild(span)
        } else if (field.nodeType === 'embedded-entry-inline') {
          const span = document.createElement('span')

          // This is how we can inject MergeTag data into Rich Text
          span.innerText = optimization.personalization.getMergeTagValue(field.data.target)

          parent.appendChild(span)
        } else {
          const span = document.createElement('span')
          span.innerText = '[unknown rich text fragment]'
          parent.appendChild(span)
        }
      }

      // Render personalized entries
      async function renderPersonalizedEntry(rawEntry, element, autoObserve = true) {
        const { entry, personalization } = optimization.personalization.personalizeEntry(rawEntry)

        if (isRichText(entry.fields?.text)) {
          const div = document.createElement('div')
          simpleRenderRichText(entry.fields.text, div)
          element.replaceChildren(div)
        } else {
          const p = document.createElement('p')
          p.innerText = entry.fields?.text
          element.replaceChildren(p)
        }

        if (entry.fields?.nested) {
          const div = document.createElement('div')
          div.className = 'nested'
          entry.fields.nested.forEach((nestedEntry) =>
            renderPersonalizedEntry(nestedEntry, div, autoObserve),
          )
          element.appendChild(div)
        }

        document
          .getElementById('entries')
          .appendChild(createEntryDialog(entry.fields.internalTitle, entry, personalization))

        // NOTE: Elements that are not auto-observed may still be auto-tracked (see below)
        if (autoObserve) {
          // The `data-ctfl-entry-id` data attribute is required for auto-observing
          element.dataset.ctflEntryId = entry.sys?.id

          // Other standard auto-observing attributes are optional
          if (personalization) {
            element.dataset.ctflPersonalizationId = personalization?.experienceId
            element.dataset.ctflSticky = personalization?.sticky
            element.dataset.ctflVariantIndex = personalization?.variantIndex
          }
        }

        return [entry, personalization]
      }

      // Get the personalized entry to render
      async function addPersonalizedEntry(entryId, element, autoObserve = true) {
        let rawEntry

        try {
          rawEntry = await contentfulClient.getEntry(entryId, { include: 10 })
        } catch (error) {
          console.warn(`Entry "${entryId}" could not be found in the current space`)
          return []
        }

        return renderPersonalizedEntry(rawEntry, element, autoObserve)
      }

      const manuallyObservedEntryElements = new Map()

      // Manually observe view elements for auto-tracking
      function manuallyObserveEntryElement(element, entry, personalization) {
        optimization.untrackEntryViewForElement(element)

        // Manually observe the element for auto-tracking (does not use `data-ctfl-*` attributes)
        optimization.trackEntryViewForElement(element, {
          data: {
            // The `entryId` property is required for auto-tracking
            entryId: entry.sys.id,
            personalizationId: personalization?.experienceId,
            sticky: personalization?.sticky,
            variantIndex: personalization?.variantIndex,
          },
        })

        manuallyObservedEntryElements.set(element.dataset.entryId, [entry, personalization])
      }

      // Subscribe to the event stream
      optimization.states.eventStream.subscribe((event) => {
        if (!event) return

        document.querySelector('#event-stream').appendChild(createEventDialog(event.type, event))
      })

      // Subscribe to consent state
      optimization.states.consent.subscribe(async (consent) => {
        toggleConsent(consent)

        if (consent)
          document.querySelectorAll('[data-entry-id]').forEach((element) => {
            const settings = manuallyObservedEntryElements.get(element.dataset.entryId)

            if (!settings) return

            const [entry, personalization] = settings

            manuallyObserveEntryElement(element, entry, personalization)
          })
      })

      // Subscribe to flags state
      optimization.states.flags.subscribe((flags) => {
        document.querySelector('#custom-flags').innerText = JSON.stringify(flags, null, 2)
      })

      // Subscribe to personalizations state
      optimization.states.personalizations.subscribe(async (personalizations) => {
        document.querySelector('#personalizations').innerText = JSON.stringify(
          personalizations,
          null,
          2,
        )
      })

      // Subscribe to profile state, find entries in the markup, and render them
      optimization.states.profile.subscribe((profile) => {
        if (!profile) return

        document.querySelector('#profile').innerText = JSON.stringify(profile, null, 2)

        toggleIdentity(profile.traits && Object.keys(profile.traits).length)

        document.querySelectorAll('[data-ctfl-entry-id]').forEach(async (element) => {
          await addPersonalizedEntry(element.dataset.ctflEntryId, element)
        })

        document.querySelectorAll('[data-entry-id]').forEach(async (element) => {
          const [entry, personalization] = await addPersonalizedEntry(
            element.dataset.entryId,
            element,
            false,
          )

          manuallyObserveEntryElement(element, entry, personalization)
        })
      })
    </script>
  </body>
</html>
