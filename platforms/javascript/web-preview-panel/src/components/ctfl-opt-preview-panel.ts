import type {
  AudienceEntry,
  PersonalizationEntry,
  Profile,
  SelectedPersonalizationArray,
} from '@contentful/optimization-web'
import { provide } from '@lit/context'
import { groupBy } from 'es-toolkit'
import { css, html, LitElement, type PropertyValues, type TemplateResult } from 'lit'
import { property, state } from 'lit/decorators.js'
import {
  ALL_VISITORS_FALLBACK_AUDIENCE,
  ALL_VISITORS_FALLBACK_AUDIENCE_ID,
} from '../global-constants'
import { overridesContext, profileContext } from '../lib/contexts'
import type { AudienceContentToggleEvent } from './ctfl-opt-preview-audience'

export const CTFL_OPT_PREVIEW_PANEL_RESET = 'ctfl-opt-preview-panel-reset'
export const CTFL_OPT_PREVIEW_PANEL_TAG = 'ctfl-opt-preview-panel'

export function isCtflOptPreviewPanel(element?: Element): element is CtflOptPreviewPanel {
  return element?.tagName === CTFL_OPT_PREVIEW_PANEL_TAG.toUpperCase()
}

function compareCount(a?: unknown[], b?: unknown[]): boolean {
  return (a?.length ?? 0) < (b?.length ?? 0)
}

function compareString(a?: string, b?: string): boolean {
  return (a ?? 'a') < (b ?? 'a')
}

export class CtflOptPreviewPanel extends LitElement {
  @property({ attribute: false })
  accessor audiences: AudienceEntry[] = []

  @property({ attribute: false })
  accessor personalizations: PersonalizationEntry[] = []

  @property({ attribute: false })
  accessor defaultSelectedPersonalizations: SelectedPersonalizationArray = []

  @provide({ context: profileContext })
  @property({ attribute: false })
  accessor profile: Profile | undefined = undefined

  @provide({ context: overridesContext })
  @property({ attribute: false })
  accessor overrides: Map<string, number> | undefined = undefined

  @state()
  private accessor _drawerOpened = false

  @state()
  private accessor _audienceContentOpenByKey: Record<string, boolean> = {}

  @state()
  private accessor _audiencePersonalizations = new Map<AudienceEntry, PersonalizationEntry[]>()

  @state()
  private accessor _audienceDefaultSelectedPersonalizations = new Map<
    AudienceEntry,
    SelectedPersonalizationArray
  >()

  private _anyAudienceContentClosed(): boolean {
    return Object.values(this._audienceContentOpenByKey).some((v) => !v)
  }

  private _onAudienceContentToggle(event: AudienceContentToggleEvent): void {
    const {
      detail: { key, open },
    } = event
    this._audienceContentOpenByKey = { ...this._audienceContentOpenByKey, [key]: open }
  }

  private _toggleAllAudienceContent(): void {
    const open = this._anyAudienceContentClosed()
    this._audienceContentOpenByKey = Object.keys(this._audienceContentOpenByKey).reduce(
      (acc: Record<string, boolean>, id) => {
        acc[id] = open
        return acc
      },
      {},
    )
  }

  private _reset(): void {
    this.dispatchEvent(
      new CustomEvent(CTFL_OPT_PREVIEW_PANEL_RESET, {
        bubbles: true,
        composed: true,
      }),
    )
  }

  protected willUpdate(changed: PropertyValues<this>): void {
    if (
      changed.has('audiences') ||
      changed.has('personalizations') ||
      changed.has('defaultSelectedPersonalizations')
    ) {
      // Convenience mapping of audience ID to audience
      const audienceIdMap = this.audiences.reduce(
        (audienceMap: Record<string, AudienceEntry>, audience) => {
          audienceMap[audience.sys.id] = audience
          return audienceMap
        },
        {},
      )

      // Mapping of audience ID to personalizations (fallback for those without audiences)
      const audienceIdPersonalizationMap = groupBy(
        // Sort by personalization name (reversed due to how `groupBy` works)
        this.personalizations.sort((a, b) =>
          compareString(a.fields.nt_name, b.fields.nt_name) ? -1 : 1,
        ),
        (personalization) =>
          personalization.fields.nt_audience?.sys.id ?? ALL_VISITORS_FALLBACK_AUDIENCE_ID,
      )

      // Add a fallback audience if necessary (useful for experiments, etc.)
      if (audienceIdPersonalizationMap[ALL_VISITORS_FALLBACK_AUDIENCE_ID]) {
        audienceIdMap[ALL_VISITORS_FALLBACK_AUDIENCE_ID] = ALL_VISITORS_FALLBACK_AUDIENCE
      }

      // Get a list of audience IDs sorted by audience name and personalization count
      const audienceIds = Object.keys(audienceIdMap)
        .sort((a, b) =>
          compareString(audienceIdMap[a]?.fields.nt_name, audienceIdMap[b]?.fields.nt_name)
            ? 1
            : -1,
        )
        .sort((a, b) =>
          compareCount(audienceIdPersonalizationMap[a], audienceIdPersonalizationMap[b]) ? 1 : -1,
        )

      this._audienceContentOpenByKey = audienceIds.reduce((acc: Record<string, boolean>, id) => {
        acc[id] = true
        return acc
      }, {})

      // Assemble the mapping of audiences to personalizations
      this._audiencePersonalizations = audienceIds.reduce((acc, audienceId) => {
        const audience = audienceIdMap[audienceId] ?? ALL_VISITORS_FALLBACK_AUDIENCE
        acc.set(audience, audienceIdPersonalizationMap[audienceId] ?? [])
        return acc
      }, new Map<AudienceEntry, PersonalizationEntry[]>())

      // Assemble the mapping of audiences to default selected personalizations
      this._audienceDefaultSelectedPersonalizations = this._audiencePersonalizations
        .keys()
        .reduce((acc, audience) => {
          const personalizations = this._audiencePersonalizations.get(audience)
          acc.set(
            audience,
            this.defaultSelectedPersonalizations.filter((defaultSelected) =>
              personalizations
                ?.map((personalization) => personalization.sys.id)
                .includes(defaultSelected.experienceId),
            ),
          )
          return acc
        }, new Map<AudienceEntry, SelectedPersonalizationArray>())
    }
  }

  protected render(): TemplateResult {
    return html`
      <button
        class="toggle-drawer ${this._drawerOpened ? 'opened' : 'closed'}"
        @click=${() => {
          this._drawerOpened = !this._drawerOpened
        }}
      >
        <svg viewBox="0 0 1203 284">
          <path
            d="M218.38 0H64.71C28.97 0 0 28.97 0 64.71V218.38C0 254.12 28.97 283.09 64.71 283.09H218.38C254.12 283.09 283.09 254.12 283.09 218.38V64.71C283.09 28.97 254.12 0 218.38 0ZM55.87 139.11C41.52 124.76 41.52 101.5 55.87 87.15C70.22 72.8 93.48 72.8 107.83 87.15C110.95 90.27 113.38 93.82 115.14 97.61C116.2 99.88 117.76 101.93 119.7 103.41C121.63 104.88 123.92 105.79 126.43 105.79C130.9 105.79 134.66 102.78 137.44 99.29C137.92 98.69 138.44 98.11 139 97.54C147.61 88.94 161.57 88.94 170.18 97.54C178.78 106.15 178.78 120.11 170.18 128.72C161.57 137.33 147.61 137.33 139 128.72C138.44 128.16 137.92 127.58 137.44 126.98C136.05 125.24 134.42 123.61 132.57 122.42C130.72 121.23 128.66 120.48 126.43 120.48C121.42 120.48 117.24 124.1 115.14 128.65C113.38 132.44 110.95 135.99 107.83 139.11C93.48 153.46 70.22 153.46 55.87 139.11ZM225.76 201.64C211.41 215.99 188.15 215.99 173.8 201.64C170.68 198.51 168.25 194.96 166.49 191.18C165.44 188.9 163.86 186.86 161.93 185.38C160 183.91 157.7 183 155.19 183C150.73 183 146.97 186.01 144.19 189.5C143.71 190.1 143.19 190.68 142.63 191.24C134.02 199.85 120.06 199.85 111.45 191.24C102.85 182.64 102.85 168.68 111.45 160.07C120.06 151.46 134.02 151.46 142.63 160.07C143.19 160.63 143.71 161.21 144.19 161.81C145.58 163.56 147.22 165.18 149.06 166.37C150.91 167.56 152.96 168.31 155.2 168.31C160.21 168.31 164.39 164.69 166.49 160.14C168.25 156.35 170.68 152.8 173.8 149.68C188.15 135.33 211.41 135.33 225.76 149.68C240.11 164.03 240.11 187.29 225.76 201.64Z"
            fill="white"
          ></path>
          <path
            d="M440.159 108.222C436.652 112.982 432.101 116.865 426.507 119.871C420.912 122.793 414.19 124.255 406.341 124.255C399.578 124.255 393.315 123.127 387.554 120.873C381.876 118.535 376.949 115.32 372.774 111.228C368.683 107.053 365.468 102.127 363.13 96.4488C360.792 90.6873 359.623 84.383 359.623 77.536C359.623 70.6054 360.792 64.3011 363.13 58.6231C365.551 52.8616 368.85 47.9768 373.025 43.9688C377.283 39.8772 382.293 36.7042 388.055 34.4497C393.816 32.1952 400.079 31.0679 406.842 31.0679C409.848 31.0679 412.896 31.3602 415.986 31.9447C419.075 32.5292 422.04 33.406 424.879 34.575C427.718 35.744 430.306 37.2052 432.644 38.9587C434.982 40.6288 436.986 42.591 438.656 44.8455L428.887 52.3606C426.716 49.3546 423.626 46.8913 419.618 44.9708C415.693 42.9668 411.435 41.9648 406.842 41.9648C401.665 41.9648 396.989 42.925 392.814 44.8455C388.723 46.6825 385.216 49.2293 382.293 52.4858C379.371 55.7423 377.116 59.5416 375.53 63.8836C373.943 68.1422 373.15 72.6929 373.15 77.536C373.15 82.546 373.901 87.222 375.404 91.5641C376.991 95.9061 379.204 99.7054 382.043 102.962C384.965 106.135 388.472 108.64 392.564 110.477C396.739 112.314 401.373 113.232 406.467 113.232C411.477 113.232 416.027 112.23 420.119 110.226C424.211 108.222 427.592 105.3 430.264 101.459L440.159 108.222ZM508.332 92.1903C508.332 96.7828 507.497 101 505.827 104.841C504.24 108.682 501.986 112.022 499.063 114.861C496.224 117.616 492.842 119.787 488.918 121.374C484.993 122.877 480.777 123.628 476.268 123.628C471.759 123.628 467.542 122.877 463.617 121.374C459.693 119.787 456.311 117.616 453.472 114.861C450.633 112.022 448.378 108.682 446.708 104.841C445.122 101 444.329 96.7828 444.329 92.1903C444.329 87.5978 445.122 83.4228 446.708 79.6652C448.378 75.8242 450.633 72.5259 453.472 69.7704C456.311 67.0149 459.693 64.8856 463.617 63.3826C467.542 61.7961 471.759 61.0029 476.268 61.0029C480.777 61.0029 484.993 61.7961 488.918 63.3826C492.842 64.8856 496.224 67.0149 499.063 69.7704C501.986 72.5259 504.24 75.8242 505.827 79.6652C507.497 83.4228 508.332 87.5978 508.332 92.1903ZM496.057 92.1903C496.057 89.3513 495.598 86.6375 494.679 84.049C493.844 81.4605 492.592 79.206 490.922 77.2855C489.252 75.2815 487.164 73.695 484.659 72.5259C482.238 71.3569 479.441 70.7724 476.268 70.7724C473.095 70.7724 470.256 71.3569 467.751 72.5259C465.329 73.695 463.283 75.2815 461.613 77.2855C459.943 79.206 458.649 81.4605 457.73 84.049C456.895 86.6375 456.478 89.3513 456.478 92.1903C456.478 95.0293 456.895 97.7431 457.73 100.332C458.649 102.92 459.943 105.216 461.613 107.22C463.283 109.224 465.329 110.811 467.751 111.98C470.256 113.149 473.095 113.733 476.268 113.733C479.441 113.733 482.238 113.149 484.659 111.98C487.164 110.811 489.252 109.224 490.922 107.22C492.592 105.216 493.844 102.92 494.679 100.332C495.598 97.7431 496.057 95.0293 496.057 92.1903ZM532.8 62.6311C532.967 64.1341 533.092 65.8459 533.175 67.7664C533.259 69.6034 533.301 71.1482 533.301 72.4007H533.676C534.428 70.8142 535.43 69.3529 536.682 68.0169C538.018 66.5974 539.521 65.3867 541.191 64.3846C542.861 63.2991 544.699 62.4641 546.703 61.8796C548.707 61.2951 550.794 61.0029 552.965 61.0029C556.806 61.0029 560.104 61.6709 562.86 63.0069C565.615 64.2594 567.912 65.9712 569.749 68.1422C571.586 70.3132 572.922 72.8599 573.757 75.7825C574.675 78.705 575.134 81.8363 575.134 85.1763V122H563.361V89.059C563.361 86.6375 563.152 84.3413 562.735 82.1703C562.401 79.9992 561.733 78.0787 560.731 76.4087C559.729 74.7387 558.351 73.4027 556.597 72.4007C554.844 71.3987 552.589 70.8977 549.834 70.8977C545.158 70.8977 541.317 72.6929 538.311 76.2835C535.388 79.7905 533.927 84.5083 533.927 90.4368V122H522.153V75.4067C522.153 73.8202 522.112 71.7744 522.028 69.2694C521.945 66.7644 521.819 64.5516 521.652 62.6311H532.8ZM621.606 72.2754H605.825V103.212C605.825 106.803 606.493 109.391 607.829 110.978C609.165 112.481 611.294 113.232 614.217 113.232C615.302 113.232 616.471 113.107 617.724 112.857C618.976 112.606 620.103 112.23 621.105 111.729L621.481 121.374C620.062 121.875 618.475 122.251 616.722 122.501C615.052 122.835 613.298 123.002 611.461 123.002C605.867 123.002 601.566 121.457 598.56 118.368C595.638 115.278 594.176 110.644 594.176 104.465V72.2754H582.779V62.6311H594.176V45.597H605.825V62.6311H621.606V72.2754ZM674.725 87.055C674.642 84.717 674.224 82.546 673.473 80.542C672.805 78.4545 671.761 76.6592 670.342 75.1562C669.006 73.6532 667.294 72.4842 665.206 71.6492C663.202 70.7307 660.823 70.2714 658.067 70.2714C655.562 70.2714 653.182 70.7307 650.928 71.6492C648.757 72.4842 646.836 73.6532 645.166 75.1562C643.58 76.6592 642.244 78.4545 641.158 80.542C640.156 82.546 639.572 84.717 639.405 87.055H674.725ZM686.624 91.8146C686.624 92.4826 686.624 93.1506 686.624 93.8186C686.624 94.4866 686.583 95.1546 686.499 95.8226H639.405C639.488 98.3276 640.031 100.707 641.033 102.962C642.118 105.133 643.538 107.053 645.292 108.723C647.045 110.31 649.049 111.562 651.304 112.481C653.642 113.399 656.105 113.859 658.693 113.859C662.701 113.859 666.167 112.982 669.089 111.228C672.012 109.475 674.308 107.346 675.978 104.841L684.244 111.479C681.071 115.654 677.314 118.743 672.972 120.747C668.713 122.668 663.954 123.628 658.693 123.628C654.184 123.628 650.009 122.877 646.168 121.374C642.327 119.871 639.029 117.783 636.273 115.111C633.518 112.356 631.347 109.057 629.76 105.216C628.174 101.375 627.381 97.1168 627.381 92.4408C627.381 87.8483 628.132 83.6315 629.635 79.7905C631.222 75.866 633.393 72.5259 636.148 69.7704C638.904 67.0149 642.16 64.8856 645.918 63.3826C649.675 61.7961 653.725 61.0029 658.067 61.0029C662.409 61.0029 666.334 61.7126 669.841 63.1321C673.431 64.5516 676.437 66.5974 678.859 69.2694C681.364 71.9414 683.284 75.198 684.62 79.039C685.956 82.7965 686.624 87.055 686.624 91.8146ZM711.204 62.6311C711.371 64.1341 711.496 65.8459 711.579 67.7664C711.663 69.6034 711.705 71.1482 711.705 72.4007H712.08C712.832 70.8142 713.834 69.3529 715.087 68.0169C716.423 66.5974 717.926 65.3867 719.596 64.3846C721.266 63.2991 723.103 62.4641 725.107 61.8796C727.111 61.2951 729.198 61.0029 731.369 61.0029C735.21 61.0029 738.508 61.6709 741.264 63.0069C744.019 64.2594 746.316 65.9712 748.153 68.1422C749.99 70.3132 751.326 72.8599 752.161 75.7825C753.079 78.705 753.538 81.8363 753.538 85.1763V122H741.765V89.059C741.765 86.6375 741.556 84.3413 741.139 82.1703C740.805 79.9992 740.137 78.0787 739.135 76.4087C738.133 74.7387 736.755 73.4027 735.001 72.4007C733.248 71.3987 730.993 70.8977 728.238 70.8977C723.562 70.8977 719.721 72.6929 716.715 76.2835C713.792 79.7905 712.331 84.5083 712.331 90.4368V122H700.557V75.4067C700.557 73.8202 700.516 71.7744 700.432 69.2694C700.349 66.7644 700.223 64.5516 700.056 62.6311H711.204ZM800.01 72.2754H784.229V103.212C784.229 106.803 784.897 109.391 786.233 110.978C787.569 112.481 789.698 113.232 792.621 113.232C793.706 113.232 794.875 113.107 796.128 112.857C797.38 112.606 798.507 112.23 799.509 111.729L799.885 121.374C798.466 121.875 796.879 122.251 795.126 122.501C793.456 122.835 791.702 123.002 789.865 123.002C784.271 123.002 779.97 121.457 776.964 118.368C774.042 115.278 772.581 110.644 772.581 104.465V72.2754H761.183V62.6311H772.581V45.597H784.229V62.6311H800.01V72.2754ZM837.598 72.2754H823.821V122H812.047V72.2754H800.274V62.6311H812.047V50.2313C812.047 46.7243 812.423 43.5095 813.174 40.587C814.009 37.581 815.304 34.9925 817.057 32.8215C818.894 30.6504 821.191 28.9387 823.946 27.6862C826.785 26.4337 830.209 25.8074 834.217 25.8074C837.056 25.8074 839.519 26.0997 841.606 26.6842L840.229 36.8295C839.31 36.579 838.392 36.3702 837.473 36.2032C836.555 36.0362 835.511 35.9527 834.342 35.9527C832.087 35.9527 830.25 36.3702 828.831 37.2052C827.495 37.9567 826.451 39.0005 825.7 40.3365C824.948 41.6725 824.447 43.2173 824.197 44.9708C823.946 46.6408 823.821 48.3943 823.821 50.2313V62.6311H837.598V72.2754ZM887.77 122C887.603 120.497 887.478 118.827 887.394 116.99C887.311 115.069 887.269 113.483 887.269 112.23H887.019C885.516 115.403 882.969 118.117 879.378 120.372C875.871 122.543 871.947 123.628 867.605 123.628C863.764 123.628 860.424 123.002 857.585 121.749C854.829 120.497 852.533 118.785 850.696 116.614C848.942 114.36 847.606 111.771 846.688 108.849C845.853 105.926 845.435 102.795 845.435 99.4549V62.6311H857.209V95.4468C857.209 97.8684 857.376 100.206 857.71 102.461C858.127 104.632 858.837 106.552 859.839 108.222C860.841 109.892 862.219 111.228 863.972 112.23C865.726 113.232 867.981 113.733 870.736 113.733C875.496 113.733 879.337 111.98 882.259 108.473C885.182 104.882 886.643 100.123 886.643 94.1943V62.6311H898.416V109.224C898.416 110.811 898.458 112.857 898.542 115.362C898.625 117.867 898.75 120.079 898.917 122H887.77ZM928.355 122H916.582V27.3104H928.355V122ZM363.13 166.322H392.063C397.156 166.322 401.749 166.782 405.84 167.7C409.932 168.619 413.439 170.122 416.361 172.209C419.284 174.297 421.539 176.969 423.125 180.225C424.712 183.482 425.505 187.406 425.505 191.999C425.505 196.925 424.586 201.059 422.749 204.399C420.912 207.739 418.407 210.452 415.234 212.54C412.145 214.544 408.512 216.005 404.337 216.924C400.162 217.842 395.737 218.302 391.061 218.302H378.912V255H363.13V166.322ZM389.934 205.025C392.522 205.025 394.985 204.858 397.323 204.524C399.661 204.106 401.749 203.438 403.586 202.52C405.423 201.518 406.884 200.182 407.97 198.512C409.055 196.842 409.598 194.671 409.598 191.999C409.598 189.41 409.055 187.323 407.97 185.736C406.884 184.066 405.423 182.772 403.586 181.854C401.832 180.935 399.787 180.351 397.449 180.1C395.194 179.766 392.856 179.599 390.435 179.599H378.912V205.025H389.934ZM470.46 218.928C470.46 217.007 470.168 215.17 469.583 213.417C469.082 211.663 468.247 210.118 467.078 208.782C465.909 207.446 464.406 206.403 462.569 205.651C460.816 204.816 458.728 204.399 456.307 204.399C451.798 204.399 447.957 205.776 444.784 208.532C441.694 211.204 439.982 214.669 439.648 218.928H470.46ZM485.49 225.691C485.49 226.359 485.49 227.027 485.49 227.695C485.49 228.363 485.448 229.031 485.365 229.699H439.648C439.815 231.87 440.358 233.874 441.277 235.711C442.279 237.465 443.573 239.01 445.159 240.346C446.746 241.598 448.541 242.6 450.545 243.352C452.549 244.103 454.637 244.479 456.808 244.479C460.565 244.479 463.738 243.811 466.327 242.475C468.915 241.055 471.045 239.135 472.715 236.713L482.735 244.729C476.806 252.745 468.206 256.754 456.933 256.754C452.257 256.754 447.957 256.044 444.032 254.624C440.108 253.121 436.684 251.034 433.762 248.362C430.923 245.69 428.668 242.433 426.998 238.592C425.412 234.668 424.618 230.242 424.618 225.316C424.618 220.473 425.412 216.089 426.998 212.164C428.668 208.156 430.923 204.774 433.762 202.019C436.601 199.18 439.941 197.009 443.782 195.506C447.706 193.919 451.923 193.126 456.432 193.126C460.607 193.126 464.448 193.836 467.955 195.255C471.546 196.591 474.635 198.637 477.224 201.393C479.812 204.065 481.816 207.446 483.236 211.538C484.739 215.546 485.49 220.264 485.49 225.691ZM497.542 194.88H511.945V204.9H512.196C513.866 201.393 516.204 198.554 519.21 196.383C522.216 194.212 525.723 193.126 529.731 193.126C530.316 193.126 530.942 193.168 531.61 193.251C532.278 193.251 532.862 193.335 533.363 193.502V207.279C532.361 207.029 531.485 206.862 530.733 206.778C530.065 206.695 529.397 206.653 528.729 206.653C525.306 206.653 522.55 207.279 520.462 208.532C518.375 209.784 516.747 211.287 515.578 213.041C514.409 214.795 513.615 216.59 513.198 218.427C512.78 220.264 512.572 221.725 512.572 222.811V255H497.542V194.88ZM573.601 210.912C572.265 209.158 570.428 207.655 568.09 206.403C565.752 205.067 563.205 204.399 560.45 204.399C558.028 204.399 555.815 204.9 553.811 205.902C551.807 206.904 550.805 208.574 550.805 210.912C550.805 213.25 551.891 214.92 554.062 215.922C556.316 216.84 559.573 217.801 563.832 218.803C566.086 219.304 568.341 219.972 570.595 220.807C572.933 221.642 575.021 222.769 576.858 224.188C578.778 225.524 580.323 227.236 581.492 229.324C582.661 231.328 583.245 233.791 583.245 236.713C583.245 240.387 582.536 243.519 581.116 246.107C579.78 248.612 577.943 250.658 575.605 252.244C573.351 253.831 570.679 254.958 567.589 255.626C564.583 256.378 561.452 256.754 558.195 256.754C553.519 256.754 548.968 255.919 544.543 254.248C540.117 252.495 536.443 250.032 533.521 246.859L543.416 237.59C545.086 239.761 547.257 241.556 549.929 242.976C552.601 244.395 555.565 245.105 558.822 245.105C559.907 245.105 560.993 244.98 562.078 244.729C563.247 244.479 564.291 244.103 565.209 243.602C566.211 243.018 567.005 242.266 567.589 241.348C568.174 240.429 568.466 239.302 568.466 237.966C568.466 235.461 567.297 233.666 564.959 232.58C562.704 231.495 559.281 230.409 554.688 229.324C552.434 228.823 550.221 228.196 548.05 227.445C545.962 226.61 544.084 225.566 542.414 224.314C540.744 222.978 539.408 221.349 538.406 219.429C537.404 217.508 536.903 215.129 536.903 212.289C536.903 208.949 537.571 206.069 538.907 203.647C540.326 201.226 542.163 199.263 544.418 197.76C546.672 196.174 549.219 195.005 552.058 194.253C554.897 193.502 557.82 193.126 560.826 193.126C565.168 193.126 569.384 193.878 573.476 195.381C577.651 196.884 580.949 199.18 583.371 202.269L573.601 210.912ZM590.302 224.689C590.302 219.93 591.137 215.63 592.807 211.788C594.56 207.864 596.898 204.524 599.821 201.768C602.743 199.013 606.208 196.884 610.216 195.381C614.224 193.878 618.483 193.126 622.992 193.126C627.501 193.126 631.76 193.878 635.768 195.381C639.776 196.884 643.241 199.013 646.163 201.768C649.086 204.524 651.382 207.864 653.052 211.788C654.806 215.63 655.682 219.93 655.682 224.689C655.682 229.449 654.806 233.791 653.052 237.715C651.382 241.64 649.086 245.022 646.163 247.861C643.241 250.616 639.776 252.787 635.768 254.374C631.76 255.96 627.501 256.754 622.992 256.754C618.483 256.754 614.224 255.96 610.216 254.374C606.208 252.787 602.743 250.616 599.821 247.861C596.898 245.022 594.56 241.64 592.807 237.715C591.137 233.791 590.302 229.449 590.302 224.689ZM605.582 224.689C605.582 227.027 605.916 229.365 606.584 231.703C607.336 234.041 608.421 236.129 609.841 237.966C611.26 239.803 613.055 241.306 615.226 242.475C617.397 243.644 619.986 244.228 622.992 244.228C625.998 244.228 628.587 243.644 630.758 242.475C632.929 241.306 634.724 239.803 636.143 237.966C637.563 236.129 638.607 234.041 639.275 231.703C640.026 229.365 640.402 227.027 640.402 224.689C640.402 222.351 640.026 220.055 639.275 217.801C638.607 215.463 637.563 213.375 636.143 211.538C634.724 209.701 632.929 208.24 630.758 207.154C628.587 205.985 625.998 205.401 622.992 205.401C619.986 205.401 617.397 205.985 615.226 207.154C613.055 208.24 611.26 209.701 609.841 211.538C608.421 213.375 607.336 215.463 606.584 217.801C605.916 220.055 605.582 222.351 605.582 224.689ZM667.751 194.88H682.029V204.524H682.28C683.616 201.518 685.912 198.888 689.168 196.633C692.508 194.295 696.433 193.126 700.942 193.126C704.867 193.126 708.207 193.836 710.962 195.255C713.801 196.591 716.097 198.387 717.851 200.641C719.688 202.896 721.024 205.484 721.859 208.407C722.694 211.329 723.111 214.335 723.111 217.425V255H708.081V221.683C708.081 219.93 707.956 218.093 707.706 216.172C707.455 214.252 706.912 212.54 706.077 211.037C705.242 209.45 704.073 208.156 702.57 207.154C701.151 206.152 699.23 205.651 696.809 205.651C694.387 205.651 692.3 206.152 690.546 207.154C688.793 208.073 687.331 209.283 686.162 210.786C685.077 212.289 684.242 214.043 683.657 216.047C683.073 217.968 682.781 219.93 682.781 221.934V255H667.751V194.88ZM775.47 247.36H775.094C773.591 250.032 771.17 252.244 767.83 253.998C764.49 255.668 760.691 256.503 756.432 256.503C754.01 256.503 751.464 256.169 748.792 255.501C746.203 254.916 743.782 253.914 741.527 252.495C739.356 250.992 737.519 249.071 736.016 246.733C734.597 244.312 733.887 241.348 733.887 237.841C733.887 233.332 735.139 229.741 737.644 227.069C740.233 224.397 743.531 222.351 747.539 220.932C751.547 219.512 755.973 218.594 760.816 218.176C765.742 217.675 770.544 217.425 775.22 217.425V215.922C775.22 212.164 773.842 209.409 771.086 207.655C768.414 205.818 765.2 204.9 761.442 204.9C758.269 204.9 755.221 205.568 752.299 206.904C749.376 208.24 746.955 209.868 745.034 211.788L737.269 202.645C740.692 199.472 744.617 197.092 749.042 195.506C753.551 193.919 758.102 193.126 762.695 193.126C768.039 193.126 772.422 193.878 775.846 195.381C779.353 196.884 782.108 198.846 784.112 201.267C786.116 203.689 787.494 206.403 788.246 209.409C789.081 212.415 789.498 215.421 789.498 218.427V255H775.47V247.36ZM775.22 227.57H771.838C769.416 227.57 766.87 227.695 764.198 227.946C761.526 228.113 759.062 228.572 756.808 229.324C754.553 229.992 752.674 230.994 751.171 232.33C749.668 233.582 748.917 235.336 748.917 237.59C748.917 239.01 749.209 240.22 749.794 241.222C750.462 242.141 751.297 242.892 752.299 243.477C753.301 244.061 754.428 244.479 755.68 244.729C756.933 244.98 758.185 245.105 759.438 245.105C764.615 245.105 768.54 243.727 771.212 240.972C773.884 238.216 775.22 234.459 775.22 229.699V227.57ZM804.754 160.31H819.784V255H804.754V160.31ZM835.764 194.88H850.794V255H835.764V194.88ZM833.634 174.464C833.634 172.042 834.511 169.955 836.265 168.201C838.102 166.364 840.398 165.446 843.153 165.446C845.909 165.446 848.205 166.322 850.042 168.076C851.963 169.746 852.923 171.875 852.923 174.464C852.923 177.052 851.963 179.223 850.042 180.977C848.205 182.647 845.909 183.482 843.153 183.482C840.398 183.482 838.102 182.605 836.265 180.852C834.511 179.015 833.634 176.885 833.634 174.464ZM861.763 241.723L894.203 206.904H863.266V194.88H912.114V208.156L879.549 242.725H913.617V255H861.763V241.723ZM961.766 247.36H961.39C959.887 250.032 957.466 252.244 954.126 253.998C950.786 255.668 946.986 256.503 942.728 256.503C940.306 256.503 937.76 256.169 935.088 255.501C932.499 254.916 930.077 253.914 927.823 252.495C925.652 250.992 923.815 249.071 922.312 246.733C920.892 244.312 920.183 241.348 920.183 237.841C920.183 233.332 921.435 229.741 923.94 227.069C926.529 224.397 929.827 222.351 933.835 220.932C937.843 219.512 942.269 218.594 947.112 218.176C952.038 217.675 956.839 217.425 961.515 217.425V215.922C961.515 212.164 960.138 209.409 957.382 207.655C954.71 205.818 951.495 204.9 947.738 204.9C944.565 204.9 941.517 205.568 938.595 206.904C935.672 208.24 933.251 209.868 931.33 211.788L923.564 202.645C926.988 199.472 930.913 197.092 935.338 195.506C939.847 193.919 944.398 193.126 948.99 193.126C954.334 193.126 958.718 193.878 962.142 195.381C965.649 196.884 968.404 198.846 970.408 201.267C972.412 203.689 973.79 206.403 974.542 209.409C975.377 212.415 975.794 215.421 975.794 218.427V255H961.766V247.36ZM961.515 227.57H958.134C955.712 227.57 953.165 227.695 950.493 227.946C947.821 228.113 945.358 228.572 943.104 229.324C940.849 229.992 938.97 230.994 937.467 232.33C935.964 233.582 935.213 235.336 935.213 237.59C935.213 239.01 935.505 240.22 936.09 241.222C936.758 242.141 937.593 242.892 938.595 243.477C939.597 244.061 940.724 244.479 941.976 244.729C943.229 244.98 944.481 245.105 945.734 245.105C950.911 245.105 954.835 243.727 957.507 240.972C960.179 238.216 961.515 234.459 961.515 229.699V227.57ZM980.934 206.904V194.88H991.455V177.47H1006.23V194.88H1021.26V206.904H1006.23V234.835C1006.23 237.507 1006.69 239.719 1007.61 241.473C1008.61 243.226 1010.79 244.103 1014.13 244.103C1015.13 244.103 1016.21 244.02 1017.38 243.853C1018.55 243.602 1019.59 243.268 1020.51 242.851L1021.01 254.624C1019.68 255.125 1018.09 255.501 1016.25 255.752C1014.42 256.086 1012.66 256.253 1010.99 256.253C1006.99 256.253 1003.73 255.71 1001.22 254.624C998.72 253.455 996.716 251.91 995.213 249.99C993.793 247.986 992.791 245.731 992.207 243.226C991.706 240.638 991.455 237.882 991.455 234.96V206.904H980.934ZM1029.89 194.88H1044.92V255H1029.89V194.88ZM1027.76 174.464C1027.76 172.042 1028.64 169.955 1030.39 168.201C1032.23 166.364 1034.52 165.446 1037.28 165.446C1040.03 165.446 1042.33 166.322 1044.17 168.076C1046.09 169.746 1047.05 171.875 1047.05 174.464C1047.05 177.052 1046.09 179.223 1044.17 180.977C1042.33 182.647 1040.03 183.482 1037.28 183.482C1034.52 183.482 1032.23 182.605 1030.39 180.852C1028.64 179.015 1027.76 176.885 1027.76 174.464ZM1057.14 224.689C1057.14 219.93 1057.97 215.63 1059.64 211.788C1061.4 207.864 1063.74 204.524 1066.66 201.768C1069.58 199.013 1073.05 196.884 1077.05 195.381C1081.06 193.878 1085.32 193.126 1089.83 193.126C1094.34 193.126 1098.6 193.878 1102.61 195.381C1106.61 196.884 1110.08 199.013 1113 201.768C1115.92 204.524 1118.22 207.864 1119.89 211.788C1121.64 215.63 1122.52 219.93 1122.52 224.689C1122.52 229.449 1121.64 233.791 1119.89 237.715C1118.22 241.64 1115.92 245.022 1113 247.861C1110.08 250.616 1106.61 252.787 1102.61 254.374C1098.6 255.96 1094.34 256.754 1089.83 256.754C1085.32 256.754 1081.06 255.96 1077.05 254.374C1073.05 252.787 1069.58 250.616 1066.66 247.861C1063.74 245.022 1061.4 241.64 1059.64 237.715C1057.97 233.791 1057.14 229.449 1057.14 224.689ZM1072.42 224.689C1072.42 227.027 1072.75 229.365 1073.42 231.703C1074.17 234.041 1075.26 236.129 1076.68 237.966C1078.1 239.803 1079.89 241.306 1082.06 242.475C1084.24 243.644 1086.82 244.228 1089.83 244.228C1092.84 244.228 1095.42 243.644 1097.6 242.475C1099.77 241.306 1101.56 239.803 1102.98 237.966C1104.4 236.129 1105.44 234.041 1106.11 231.703C1106.86 229.365 1107.24 227.027 1107.24 224.689C1107.24 222.351 1106.86 220.055 1106.11 217.801C1105.44 215.463 1104.4 213.375 1102.98 211.538C1101.56 209.701 1099.77 208.24 1097.6 207.154C1095.42 205.985 1092.84 205.401 1089.83 205.401C1086.82 205.401 1084.24 205.985 1082.06 207.154C1079.89 208.24 1078.1 209.701 1076.68 211.538C1075.26 213.375 1074.17 215.463 1073.42 217.801C1072.75 220.055 1072.42 222.351 1072.42 224.689ZM1134.59 194.88H1148.87V204.524H1149.12C1150.45 201.518 1152.75 198.888 1156.01 196.633C1159.35 194.295 1163.27 193.126 1167.78 193.126C1171.7 193.126 1175.04 193.836 1177.8 195.255C1180.64 196.591 1182.94 198.387 1184.69 200.641C1186.53 202.896 1187.86 205.484 1188.7 208.407C1189.53 211.329 1189.95 214.335 1189.95 217.425V255H1174.92V221.683C1174.92 219.93 1174.79 218.093 1174.54 216.172C1174.29 214.252 1173.75 212.54 1172.92 211.037C1172.08 209.45 1170.91 208.156 1169.41 207.154C1167.99 206.152 1166.07 205.651 1163.65 205.651C1161.23 205.651 1159.14 206.152 1157.38 207.154C1155.63 208.073 1154.17 209.283 1153 210.786C1151.91 212.289 1151.08 214.043 1150.5 216.047C1149.91 217.968 1149.62 219.93 1149.62 221.934V255H1134.59V194.88Z"
            fill="white"
          ></path>
        </svg>
      </button>

      <div class="body" ?inert=${!this._drawerOpened}>
        <div class="header">
          <p class="heading">Personalization Preview</p>
          <p class="subheading">Select an audience to segment preview content.</p>
        </div>

        <p>
          <button
            class="toggle"
            @click=${() => {
              this._toggleAllAudienceContent()
            }}
          >
            ${this._anyAudienceContentClosed() ? 'Expand all' : 'Collapse all'}
          </button>
        </p>

        <div class="container">
          ${Array.from(this._audiencePersonalizations.entries()).map(
            ([audience, personalizations]) => html`
              <ctfl-opt-preview-audience
                .open=${this._audienceContentOpenByKey[audience.sys.id] ?? true}
                .audience=${audience}
                .personalizations=${personalizations}
                .defaultSelectedPersonalizations=${this._audienceDefaultSelectedPersonalizations.get(
                  audience,
                )}
                @ctfl_opt_preview_audience_content_toggle=${(event: AudienceContentToggleEvent) => {
                  this._onAudienceContentToggle(event)
                }}
              ></ctfl-opt-preview-audience>
            `,
          )}
        </div>

        <div class="footer">
          <button
            @click=${() => {
              this._drawerOpened = false
            }}
          >
            Close
          </button>

          <button
            @click=${() => {
              this._reset()
            }}
            class="primary"
          >
            Reset Profile
          </button>
        </div>
      </div>
    `
  }

  static styles = css`
    * {
      box-sizing: border-box;
    }

    :host {
      position: fixed;
      z-index: 999999;
      top: 0;
      right: 0;
      bottom: 0;
      display: grid;
      width: 24rem;
      font-size: 1rem;
      font-family:
        ui-sans-serif,
        system-ui,
        sans-serif,
        Apple Color Emoji,
        Segoe UI Emoji,
        Segoe UI Symbol,
        Noto Color Emoji;
      color: #222;
      background: #fff;
      box-shadow:
        rgba(0, 0, 0, 0) 0px 0px 0px 0px,
        rgba(0, 0, 0, 0) 0px 0px 0px 0px,
        rgba(0, 0, 0, 0.1) 0px 4px 6px -1px,
        rgba(0, 0, 0, 0.1) 0px 2px 4px -2px;
      transform: translate(24rem, 0px);
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 700ms;
      transition-property: transform;
    }

    :host:has(.toggle-drawer.opened) {
      transform: translate(0px, 0px);
    }

    p {
      margin: 0;
    }

    button {
      cursor: pointer;
    }

    button:focus-visible {
      outline: 2px solid rgb(112, 37, 187);
      outline-offset: 2px;
    }

    .body {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 0;
      padding: 1.5rem 1rem;
    }

    .toggle,
    .toggle-drawer {
      all: unset;
      box-sizing: border-box;
      cursor: pointer;
      font: inherit;
    }

    .toggle {
      display: flex;
      gap: 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: rgb(140, 46, 234);
      -webkit-appearance: none;
      appearance: none;
    }

    .toggle:active,
    .toggle:focus,
    .toggle:hover {
      text-decoration: underline;
    }

    .toggle-drawer {
      position: absolute;
      bottom: 10dvh;
      right: 100%;
      display: grid;
      height: 14rem;
      width: 3rem;
      padding: 3rem 0.5rem;
      background: rgb(140, 46, 234);
      overflow: hidden;
      border-radius: 0.5rem 0 0 0.5rem;
    }

    .toggle-drawer svg {
      width: 128px;
      transform: rotate(270deg);
      transform-origin: 64px 64px;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .heading {
      font-size: 1.5rem;
      font-weight: 600;
      line-height: 2rem;
    }

    .subheading {
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: rgb(107, 114, 128);
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .container::-webkit-scrollbar {
      display: none;
    }

    .footer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .footer button {
      width: 100%;
      padding: 0.625rem 1rem;
      border: 1px solid rgb(209, 213, 219);
      border-radius: 0.375rem;
      background: transparent;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.25rem;
    }

    .footer button:hover {
      background-color: rgb(249, 250, 251);
    }

    .footer button:active,
    .footer button:focus-visible {
      outline: 2px solid rgb(112, 37, 187);
      outline-offset: 2px;
    }

    .footer button.primary {
      border: 0;
      background: rgb(140, 46, 234);
      color: #fff;
    }

    .footer button.primary:hover {
      background: rgb(126, 41, 211);
    }
  `
}

export function defineCtflOptPreviewPanel(): void {
  if (!customElements.get(CTFL_OPT_PREVIEW_PANEL_TAG)) {
    customElements.define(CTFL_OPT_PREVIEW_PANEL_TAG, CtflOptPreviewPanel)
  }
}
