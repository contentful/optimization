name: Publish to NPM

permissions:
  contents: read
  id-token: write
  packages: write

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Existing release tag (e.g. v1.2.3)'
        required: true
      publish:
        description: 'Actually publish'
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve Secrets from Vault
        id: vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          url: ${{ secrets.VAULT_URL }}
          role: ${{ github.event.repository.name }}-github-action
          method: jwt
          path: github-actions
          secrets: |
            secret/data/github/github_packages_write GITHUB_PACKAGES_WRITE_TOKEN | GITHUB_PACKAGES_WRITE_TOKEN;

      - name: Derive release version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG='${{ github.event.release.tag_name }}'
          else
            TAG='${{ inputs.tag }}'
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"
          echo "RELEASE_VERSION=${TAG#v}" >> "$GITHUB_ENV"

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          package-manager-cache: false

      - uses: pnpm/action-setup@v4

      - run: |
          pnpm install --prefer-offline --frozen-lockfile

      - name: Bump package.json versions
        run: |
          pnpm -r --filter "@contentful/optimization-*" exec \
            npm --no-git-tag-version --force version "$RELEASE_VERSION"
        env:
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}

      - name: Build
        run: pnpm build
        env:
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}

      - name: Create packages for troubleshooting
        run: pnpm pack --recursive --filter "@contentful/optimization-*" --pack-destination pkgs

      - name: Upload packages for troubleshooting
        uses: actions/upload-artifact@v6
        with:
          name: ci-optimization-sdk-packages
          path: |
            ./pkgs/
          retention-days: 3

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@contentful'
          package-manager-cache: false

      - name: Publish
        if: github.event_name == 'release' || inputs.publish
        run: pnpm -r --filter "@contentful/optimization-*" publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ steps.vault.outputs.GITHUB_PACKAGES_WRITE_TOKEN }}
